<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Text & PNG Overlay Maker — slots stable</title>
  <style>
    @font-face { font-family:'Aeroport'; src:url('Aeroport-Bold.ttf') format('truetype'); font-weight:700; font-style:normal; font-display:swap; }
    :root{--bg:#0b0f14;--panel:rgba(255,255,255,.06);--stroke:rgba(255,255,255,.15);--text:#e8eef6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:18px;margin:0 0 8px 0}
    .wrap{display:grid;grid-template-columns:1fr;gap:12px;min-height:100vh;padding:12px}
    .card{backdrop-filter:saturate(1.2) blur(8px);background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:12px}
    label{display:block;font-size:12px;color:#b8c4d4;margin:8px 0 6px}
    textarea{min-height:140px;resize:vertical;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);padding:10px;width:100%}
    input,button{border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);padding:10px;width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .controls{display:grid;gap:8px}
    .btn{cursor:pointer;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));padding:10px;font-weight:600;color:var(--text)}
    .btn:hover{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05))}
    /* две карточки в ряд, компактно */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .slot{position:relative;border:1px solid var(--stroke);border-radius:12px;overflow:hidden;background:#0b0f14}
    .slot canvas{display:none;width:100%;height:auto}
    .slot img.preview{display:block;width:100%;height:auto;-webkit-touch-callout: default; image-rendering:auto}
    .bar{display:flex;gap:8px;padding:8px;align-items:center}
    .bar .note{font-size:12px;color:#9fb0c6}
    .actions{display:flex;gap:8px}
    @media (min-width:1024px){ .wrap{grid-template-columns:420px 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Наложение текста на фото</h1>
      <div class="controls">
        <label>Текст — пустая строка = новый абзац → отдельная карточка ниже</label>
        <textarea id="captions" placeholder="Твой текст...&#10;&#10;Следующий абзац..."></textarea>

        <div class="row">
          <div>
            <label>Размер текста, px</label>
            <input id="fontSize" type="number" min="8" max="256" value="40" />
          </div>
          <div>
            <label>Межстрочный, %</label>
            <input id="lineHeight" type="number" min="90" max="200" value="120" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Цвет текста</label>
            <input id="fontColor" type="text" value="#ffffff" />
          </div>
          <div>
            <label>Подложка</label>
            <input id="reloadBg" class="btn" type="button" value="Перечитать Background.png" />
          </div>
        </div>

        <div class="row">
          <button class="btn" id="downloadAll">Скачать все PNG (1,2,3...)</button>
          <div class="note" id="bgStatus">Используем: Background.png</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h1>Результаты (зажми картинку → «Сохранить изображение»)</h1>
      <div id="results" class="grid"></div>
    </div>
  </div>

  <script>
    // фиксированные значения
    const FIX_SAFE_BOTTOM = 135, FIX_LEFT = 92, FIX_RIGHT = 90;
    const BG_FILE = 'Background.png';

    const $ = (id)=>document.getElementById(id);
    const captionsEl = $("captions");
    const fontSize   = $("fontSize");
    const lineHeight = $("lineHeight");
    const fontColor  = $("fontColor");
    const results    = $("results");
    const downloadAllBtn = $("downloadAll");
    const reloadBgBtn    = $("reloadBg");
    const bgStatus       = $("bgStatus");

    let overlayImg = null;
    let slots = []; // {container, canvas, imgTag, fileInput, imgDataUrl, imgEl, text}

    function dataUrlFromFile(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    function imgFromDataUrl(url){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload=()=> resolve(img);
        img.onerror=reject;
        img.src=url;
      });
    }
    function wrapText(ctx, text, maxWidth){
      const words = text.split(/\s+/);
      const lines=[]; let line="";
      for(const w of words){
        const test=line?line+" "+w:w;
        if(ctx.measureText(test).width>maxWidth && line){ lines.push(line); line=w; }
        else { line=test; }
      }
      if(line) lines.push(line);
      return lines;
    }
    function objectFitCoverDraw(ctx, img, W, H){
      const scale = Math.max(W/img.naturalWidth, H/img.naturalHeight);
      const drawW = img.naturalWidth*scale;
      const drawH = img.naturalHeight*scale;
      const dx = (W-drawW)/2;
      const dy = (H-drawH)/2;
      ctx.drawImage(img, dx, dy, drawW, drawH);
    }
    async function loadBackground(){
      bgStatus.textContent = 'Идёт загрузка: ' + BG_FILE;
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{ overlayImg = img; bgStatus.textContent = 'Используем: ' + BG_FILE; resolve(true); };
        img.onerror = ()=>{ overlayImg = null; bgStatus.textContent = 'Не найден: ' + BG_FILE + ' (продолжаем без подложки)'; resolve(false); };
        img.src = BG_FILE + '?v=' + Date.now();
      });
    }

    function paragraphs(){ return captionsEl.value.split(/\n\s*\n/g).map(s=>s.trim()); }

    function ensureSlots(count){
      while(slots.length < count){
        const idx = slots.length;
        const slot = document.createElement('div'); slot.className='slot';
        const canvas = document.createElement('canvas');
        const imgTag = document.createElement('img'); imgTag.className='preview'; imgTag.alt='preview'; imgTag.decoding='async'; imgTag.loading='eager';
        const bar = document.createElement('div'); bar.className='bar';
        const file = document.createElement('input'); file.type='file'; file.accept='image/*';
        const hint = document.createElement('div'); hint.className='note'; hint.textContent='Фото '+(idx+1);
        const actions = document.createElement('div'); actions.className='actions';
        const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Скачать PNG';

        actions.appendChild(dl);
        bar.appendChild(file); bar.appendChild(hint); bar.appendChild(actions);
        slot.appendChild(imgTag); slot.appendChild(bar);
        results.appendChild(slot);

        const rec = {container:slot, canvas, imgTag, fileInput:file, imgDataUrl:null, imgEl:null, text:""};
        file.addEventListener('change', async ()=>{
          if(file.files && file.files[0]){
            rec.imgDataUrl = await dataUrlFromFile(file.files[0]);
            rec.imgEl = await imgFromDataUrl(rec.imgDataUrl);
            await renderSlot(rec);
          }
        });
        dl.addEventListener('click', ()=> downloadCanvasPNG(canvas, idx));
        slots.push(rec);
      }
      while(slots.length > count){
        const rec = slots.pop();
        rec.container.remove();
      }
    }

    function downloadCanvasPNG(canvas, index){
      try{
        const a=document.createElement('a');
        a.href=canvas.toDataURL('image/png');
        a.download=`result_${String(index+1).padStart(2,'0')}.png`;
        document.body.appendChild(a); a.click(); a.remove();
      }catch(e){}
    }

    async function renderSlot(rec){
      // размеры
      const W = overlayImg? overlayImg.naturalWidth : (rec.imgEl? rec.imgEl.naturalWidth : 1080);
      const H = overlayImg? overlayImg.naturalHeight: (rec.imgEl? rec.imgEl.naturalHeight: 1920);

      const c = rec.canvas; c.width=W; c.height=H; const ctx=c.getContext('2d');
      ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
      if(rec.imgEl) objectFitCoverDraw(ctx, rec.imgEl, W, H);
      if(overlayImg) ctx.drawImage(overlayImg,0,0,W,H);

      ctx.font = `700 ${parseInt(fontSize.value,10)}px Aeroport, system-ui, sans-serif`;
      ctx.textAlign='left'; ctx.textBaseline='top';
      ctx.fillStyle=fontColor.value;

      const maxW = Math.max(10, W - FIX_LEFT - FIX_RIGHT);
      const lines = rec.text? wrapText(ctx, rec.text, maxW) : [];
      const step = parseInt(fontSize.value,10) * (parseFloat(lineHeight.value)/100);
      const blockH = lines.length * step;
      const yBottom = H - FIX_SAFE_BOTTOM;
      const y = Math.max(10, yBottom - blockH - 4);
      const x = FIX_LEFT;
      for(let i=0;i<lines.length;i++) ctx.fillText(lines[i], x, y + i*step);

      // обновляем видимое превью (для долгого тапа «Сохранить изображение»)
      try{
        const url = c.toDataURL('image/png');
        // если браузер «не сразу» показывает, продублируем обновление в microtask
        rec.imgTag.src = '';
        queueMicrotask(()=>{ rec.imgTag.src = url; rec.imgTag.style.display='block'; });
      }catch(e){}
    }

    async function renderAll(){
      const paras = paragraphs();
      ensureSlots(paras.length);
      for(let i=0;i<slots.length;i++){
        slots[i].text = paras[i] || '';
        await renderSlot(slots[i]);
      }
    }

    captionsEl.addEventListener('input', renderAll);
    [fontSize,lineHeight,fontColor].forEach(el=> el.addEventListener('input', renderAll));
    downloadAllBtn.addEventListener('click', ()=>{ for(let i=0;i<slots.length;i++) downloadCanvasPNG(slots[i].canvas, i); });
    reloadBgBtn.addEventListener('click', async ()=>{ await loadBackground(); await renderAll(); });

    (async()=>{ await loadBackground(); await renderAll(); })();
  </script>
</body>
</html>
