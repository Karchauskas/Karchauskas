<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Text & PNG Overlay Maker</title>
  <style>
    @font-face {
      font-family: 'Aeroport';
      src: url('Aeroport-Bold.ttf') format('truetype');
      font-weight: bold;
      font-style: normal;
    }
    :root{--bg:#0b0f14;--panel:rgba(255,255,255,.06);--stroke:rgba(255,255,255,.15);--text:#e8eef6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:18px;margin:0 0 8px 0}
    .wrap{display:grid;grid-template-columns:380px 1fr;gap:16px;min-height:100vh;padding:16px}
    .card{backdrop-filter:saturate(1.2) blur(8px);background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:14px}
    label{display:block;font-size:12px;color:#b8c4d4;margin:8px 0 6px}
    input[type="file"],textarea,button{width:100%}
    textarea{min-height:140px;resize:vertical;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);padding:10px}
    .controls{display:grid;gap:8px}
    .btn{cursor:pointer;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));padding:10px;font-weight:600;color:var(--text)}
    .btn:hover{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05))}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .thumb{position:relative;border:1px solid var(--stroke);border-radius:12px;overflow:hidden;background:#0b0f14}
    .thumb canvas{display:block;width:100%;height:auto}
    .thumb .actions{position:absolute;inset:auto 8px 8px 8px;display:flex;gap:8px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.4);cursor:pointer}
    .note{font-size:12px;color:#9fb0c6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Наложение текста на фото</h1>
      <div class="controls">
        <label>Фотографии (можно несколько, порядок важен)</label>
        <input id="imagesInput" type="file" accept="image/*" multiple />

        <label>Текст — общий блок. Пустая строка = новый абзац → подпись для следующей картинки</label>
        <textarea id="captions" placeholder="Абзац 1&#10;&#10;Абзац 2&#10;&#10;Абзац 3 ..."></textarea>

        <div class="row3">
          <div>
            <label>Цвет текста</label>
            <input id="fontColor" type="text" value="#ffffff" />
          </div>
          <div>
            <label>Контур (stroke), px</label>
            <input id="strokeWidth" type="number" min="0" max="10" value="2" />
          </div>
          <div>
            <label>Цвет контура</label>
            <input id="strokeColor" type="text" value="#000000" />
          </div>
        </div>

        <div class="row">
          <button class="btn" id="renderBtn">Собрать превью</button>
          <button class="btn" id="downloadAll">Скачать все</button>
        </div>

        <div id="overlayStatus" class="note">Подложка: ищем…</div>
      </div>
    </div>

    <div class="card">
      <h1>Результаты</h1>
      <div id="results" class="grid"></div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const imagesInput  = $("imagesInput");
    const captionsEl   = $("captions");
    const fontColor    = $("fontColor");
    const strokeWidth  = $("strokeWidth");
    const strokeColor  = $("strokeColor");
    const renderBtn    = $("renderBtn");
    const results      = $("results");
    const overlayStatus= $("overlayStatus");

    const FIXED_FONT = 'bold 40px Aeroport, sans-serif';
    const FIXED_PADDING = 56;
    const FIXED_SAFE_BOTTOM = 132;
    const FIXED_TEXT_WIDTH_PCT = 85;
    const FIXED_ALIGN = 'center';
    const FIXED_LINE_HEIGHT = 1.2;

    function loadImageFromFile(file){
      return new Promise((resolve,reject)=>{
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload=()=>{ URL.revokeObjectURL(url); resolve(img); };
        img.onerror=reject;
        img.src=url;
      });
    }

    function wrapText(ctx, text, maxWidth){
      const words = text.split(/\s+/);
      const lines=[]; let line="";
      for(const w of words){
        const test=line?line+" "+w:w;
        if(ctx.measureText(test).width>maxWidth && line){ lines.push(line); line=w; }
        else { line=test; }
      }
      if(line) lines.push(line);
      return lines;
    }

    function drawMultiline(ctx, lines, x, y, lineHeight){
      ctx.textAlign = FIXED_ALIGN;
      ctx.textBaseline = "top";
      const step = parseInt(40,10) * lineHeight;
      for(let i=0;i<lines.length;i++){
        const ly = y + i * step;
        if(parseInt(strokeWidth.value,10)>0){
          ctx.lineWidth=parseInt(strokeWidth.value,10);
          ctx.strokeStyle=strokeColor.value;
          ctx.strokeText(lines[i], x, ly);
        }
        ctx.fillStyle=fontColor.value;
        ctx.fillText(lines[i], x, ly);
      }
    }

    function loadOverlay(names, cb){
      let idx = 0;
      const tryNext = ()=>{
        if(idx>=names.length) return cb(null,null);
        const img = new Image();
        img.onload = ()=> cb(img,names[idx]);
        img.onerror = ()=> { idx++; tryNext(); };
        img.src = names[idx] + "?v="+Date.now();
      };
      tryNext();
    }

    async function render(){
      results.innerHTML="";
      const files = Array.from(imagesInput.files||[]);
      if(files.length===0){ alert("Добавь хотя бы одну фотографию"); return; }

      loadOverlay(["overlay.png","Overlay.png","Backgroung.png","background.png","Background.png"], async (overlayImg,overlayName)=>{
        overlayStatus.textContent = overlayImg ? `Подложка: найдена (${overlayName})` : "Подложка: не найдена";

        const captions = captionsEl.value.split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean);

        for(let i=0;i<files.length;i++){
          const photo = await loadImageFromFile(files[i]);
          const W = overlayImg? overlayImg.naturalWidth  : photo.naturalWidth;
          const H = overlayImg? overlayImg.naturalHeight : photo.naturalHeight;

          const c = document.createElement("canvas"); c.width=W; c.height=H;
          const ctx = c.getContext("2d");

          const scale = Math.max(W/photo.naturalWidth, H/photo.naturalHeight);
          const drawW = photo.naturalWidth*scale;
          const drawH = photo.naturalHeight*scale;
          const dx = (W-drawW)/2;
          const dy = (H-drawH)/2;
          ctx.drawImage(photo, dx, dy, drawW, drawH);

          if(overlayImg) ctx.drawImage(overlayImg, 0, 0, W, H);

          ctx.font = FIXED_FONT;
          const maxW = Math.round(W * (FIXED_TEXT_WIDTH_PCT/100));
          const lines = captions[i] ? wrapText(ctx, captions[i], maxW) : [];

          const textAreaLeft = (W - maxW)/2;
          let x = W/2; // по центру фиксировано

          const step = parseInt(40,10) * FIXED_LINE_HEIGHT;
          const textBlockH = lines.length * step;
          const bottomLimit = H - FIXED_SAFE_BOTTOM;
          const y = Math.max(FIXED_PADDING, bottomLimit - textBlockH - 4);

          drawMultiline(ctx, lines, x, y, FIXED_LINE_HEIGHT);

          const item=document.createElement("div");
          item.className="thumb";
          item.appendChild(c);
          const actions=document.createElement("div"); actions.className="actions";
          const btn=document.createElement("button"); btn.className="pill"; btn.textContent="Скачать PNG";
          btn.addEventListener("click",()=>{
            const a=document.createElement('a');
            a.href=c.toDataURL("image/png");
            a.download=`result_${String(i+1).padStart(2,'0')}.png`;
            a.click();
          });
          actions.appendChild(btn);
          item.appendChild(actions);
          results.appendChild(item);
        }
      });
    }

    $("renderBtn").addEventListener("click", render);
    $("downloadAll").addEventListener("click", ()=>{
      const btns = results.querySelectorAll(".pill");
      if(btns.length===0){ alert("Сначала собери превью"); return; }
      btns.forEach((b,idx)=> setTimeout(()=>b.click(), idx*150));
    });
  </script>
</body>
</html>
