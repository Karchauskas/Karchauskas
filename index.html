<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Text & PNG Overlay Maker</title>
  <style>
    :root{--bg:#0b0f14;--panel:rgba(255,255,255,.06);--stroke:rgba(255,255,255,.15);--text:#e8eef6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:18px;margin:0 0 8px 0}
    .wrap{display:grid;grid-template-columns:380px 1fr;gap:16px;min-height:100vh;padding:16px}
    .card{backdrop-filter:saturate(1.2) blur(8px);background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:14px}
    label{display:block;font-size:12px;color:#b8c4d4;margin:8px 0 6px}
    input[type="file"],select,textarea,input[type="number"],input[type="text"],button{width:100%}
    textarea{min-height:140px;resize:vertical;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);padding:10px}
    input,select{border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.03);color:var(--text);padding:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .controls{display:grid;gap:8px}
    .btn{cursor:pointer;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));padding:10px;font-weight:600;color:var(--text)}
    .btn:hover{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05))}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .thumb{position:relative;border:1px solid var(--stroke);border-radius:12px;overflow:hidden;background:#0b0f14}
    .thumb canvas{display:block;width:100%;height:auto}
    .thumb .actions{position:absolute;inset:auto 8px 8px 8px;display:flex;gap:8px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.4);cursor:pointer}
    .drag{border:1px dashed var(--stroke);border-radius:12px;padding:16px;text-align:center;color:#9fb0c6}
    .hr{height:1px;background:var(--stroke);margin:10px 0}
    .note{font-size:12px;color:#9fb0c6}
    .inline{display:flex;gap:8px;align-items:center}
    .inline input[type="checkbox"]{width:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Наложение текста на фото</h1>
      <div class="controls">
        <label>Фотографии (можно несколько, порядок важен)</label>
        <input id="imagesInput" type="file" accept="image/*" multiple />
        <label>Текст для подписей — один общий блок. Пустая строка = новый абзац → подпись для следующей картинки</label>
        <textarea id="captions" placeholder="Абзац 1\n\nАбзац 2\n\nАбзац 3 ..."></textarea>
        <div class="row">
          <div>
            <label>Шрифт</label>
            <select id="fontFamily">
              <option value="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial">Inter / system</option>
              <option value="Georgia, serif">Georgia</option>
              <option value="Times New Roman, Times, serif">Times</option>
              <option value="Courier New, ui-monospace, SFMono-Regular, Menlo, monospace">Monospace</option>
            </select>
          </div>
          <div class="row">
            <div>
              <label>Размер, px</label>
              <input id="fontSize" type="number" min="8" max="256" value="40" />
            </div>
            <div>
              <label>Межстрочный, %</label>
              <input id="lineHeight" type="number" min="80" max="200" value="120" />
            </div>
          </div>
        </div>
        <div class="row3">
          <div>
            <label>Цвет текста</label>
            <input id="fontColor" type="text" value="#ffffff" />
          </div>
          <div>
            <label>Контур (stroke), px</label>
            <input id="strokeWidth" type="number" min="0" max="10" value="2" />
          </div>
          <div>
            <label>Цвет контура</label>
            <input id="strokeColor" type="text" value="#000000" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Выравнивание</label>
            <select id="textAlign">
              <option value="center">По центру</option>
              <option value="left">Слева</option>
              <option value="right">Справа</option>
            </select>
          </div>
          <div>
            <label>Поля (внутр.), px</label>
            <input id="padding" type="number" min="0" max="400" value="60" />
          </div>
        </div>
        <div class="row">
          <div class="inline">
            <input id="shadow" type="checkbox" checked />
            <label for="shadow">Лёгкая тень текста</label>
          </div>
          <div></div>
        </div>
        <div class="row">
          <div>
            <label>Безопасная зона снизу, px (текст выше линии)</label>
            <input id="safeBottom" type="number" min="0" max="600" value="170" />
          </div>
          <div>
            <label>Ширина области текста, % от ширины холста</label>
            <input id="textWidthPct" type="number" min="40" max="100" value="88" />
          </div>
        </div>
        <div class="row">
          <button class="btn" id="renderBtn">Собрать превью</button>
          <button class="btn" id="downloadAll">Скачать все</button>
        </div>
        <div class="note">Подложка берётся из файла <code>Backgroung.png</code>. Текст ограничивается безопасной зоной снизу и не опускается на линию.</div>
      </div>
    </div>

    <div class="card">
      <h1>Результаты</h1>
      <div id="results" class="grid"></div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const imagesInput  = $("imagesInput");
    const captionsEl   = $("captions");
    const fontFamily   = $("fontFamily");
    const fontSize     = $("fontSize");
    const lineHeight   = $("lineHeight");
    const fontColor    = $("fontColor");
    const strokeWidth  = $("strokeWidth");
    const strokeColor  = $("strokeColor");
    const textAlign    = $("textAlign");
    const padding      = $("padding");
    const shadow       = $("shadow");
    const renderBtn    = $("renderBtn");
    const results      = $("results");
    const safeBottom   = $("safeBottom");
    const textWidthPct = $("textWidthPct");

    async function loadImage(src){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload=()=>resolve(img);
        img.onerror=reject;
        img.src=src;
      });
    }

    function wrapText(ctx, text, maxWidth){
      const words=text.split(/\s+/);
      const lines=[]; let line="";
      for(const w of words){
        const test=line?line+" "+w:w;
        if(ctx.measureText(test).width>maxWidth&&line){lines.push(line);line=w;}else{line=test;}}
      if(line)lines.push(line);
      return lines;
    }

    function drawMultiline(ctx, lines, x, y){
      ctx.textAlign=textAlign.value;
      ctx.textBaseline="top";
      if(shadow.checked){ctx.shadowColor="rgba(0,0,0,.6)";ctx.shadowBlur=6;ctx.shadowOffsetY=2;} else {ctx.shadowBlur=0;ctx.shadowOffsetY=0;}
      for(let i=0;i<lines.length;i++){
        const ly=y+i*(parseFloat(lineHeight.value)/100*parseInt(fontSize.value,10));
        if(parseInt(strokeWidth.value,10)>0){ctx.lineWidth=parseInt(strokeWidth.value,10);ctx.strokeStyle=strokeColor.value;ctx.strokeText(lines[i],x,ly);}
        ctx.fillStyle=fontColor.value;ctx.fillText(lines[i],x,ly);
      }
    }

    async function render(){
      results.innerHTML="";
      const files=Array.from(imagesInput.files||[]);
      if(files.length===0){alert("Добавь хотя бы одну фотографию");return;}

      const overlayImg=await loadImage("Backgroung.png");

      const captions=captionsEl.value.split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean);

      for(let i=0;i<files.length;i++){
        const photo=await loadImage(URL.createObjectURL(files[i]));
        const W=overlayImg.naturalWidth;
        const H=overlayImg.naturalHeight;

        const c=document.createElement("canvas");
        c.width=W;c.height=H;
        const ctx=c.getContext("2d");

        const scale=Math.max(W/photo.naturalWidth,H/photo.naturalHeight);
        const drawW=photo.naturalWidth*scale;
        const drawH=photo.naturalHeight*scale;
        const dx=(W-drawW)/2;
        const dy=(H-drawH)/2;
        ctx.drawImage(photo,dx,dy,drawW,drawH);

        ctx.font=`${parseInt(fontSize.value,10)}px ${fontFamily.value}`;
        const maxW=Math.round(W*(parseInt(textWidthPct.value||88,10)/100));
        const lines=captions[i]?wrapText(ctx,captions[i],maxW):[];

        const textAreaLeft=(W-maxW)/2; const pad=parseInt(padding.value,10);
        let x=textAreaLeft+pad; if(textAlign.value==="center") x=W/2; if(textAlign.value==="right") x=W-textAreaLeft-pad;
        const lineStep=(parseFloat(lineHeight.value)/100*parseInt(fontSize.value,10));
        const textHeight=lines.length*lineStep;
        const bottomLimit=H-parseInt(safeBottom.value||200,10);
        const y=Math.max(pad, bottomLimit - textHeight - 4);

        drawMultiline(ctx,lines,x,y);

        ctx.drawImage(overlayImg,0,0,W,H);

        const item=document.createElement("div");
        item.className="thumb";
        item.appendChild(c);
        const actions=document.createElement("div");
        actions.className="actions";
        const btn=document.createElement("button");
        btn.className="pill";
        btn.textContent="Скачать PNG";
        btn.addEventListener("click",()=>{
          const a=document.createElement('a');
          a.href=c.toDataURL("image/png");
          a.download=`result_${String(i+1).padStart(2,'0')}.png`;
          a.click();
        });
        actions.appendChild(btn);
        item.appendChild(actions);
        results.appendChild(item);
      }
    }

    renderBtn.addEventListener("click",render);
    $("downloadAll").addEventListener("click",()=>{
      const btns=results.querySelectorAll(".pill");
      if(btns.length===0){alert("Сначала собери превью");return;}
      btns.forEach((b,idx)=>setTimeout(()=>b.click(),idx*150));
    });
  </script>
</body>
</html>
